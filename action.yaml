---
name: Wrapper for hashicorp/vault-action
author: Malena Ebert
description: Simplifies the usage of hashicorp/vault-action
branding:
  color: green
  icon: lock
inputs:
  url:
    description: url of the HC vault instance
    default: https://vault.sonar.build
    required: false
  secrets:
    description: pattern to fetch secrets
    required: true
  ttl:
    description: 'Optional TTL for Vault tokens (e.g., "3h", "10800s"). If not specified, uses the role default.'
    required: false
    default: ''
outputs:
  vault:
    description: Outputs of vault
    value: ${{ toJSON(steps.secrets.outputs) }}
runs:
  using: composite
  steps:
    - name: replace placeholder
      id: replace
      # GITHUB_REPOSITORY=octocat/Hello-World
      # GITHUB_REPOSITORY_OWNER=octocat
      # REPO_NAME=Hello-World
      # REPO_OWNER_NAME_DASH=octocat-Hello-World
      env:
        SECRET_PATTERN: ${{ inputs.secrets }}
        TTL_INPUT: ${{ inputs.ttl }}
      uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
      with:
        script: |
          let pattern = process.env.SECRET_PATTERN
            .replaceAll(
              '{GITHUB_REPOSITORY_OWNER}',
              context.repo.owner
            )
            .replaceAll(
              '{GITHUB_REPOSITORY}',
              `${context.repo.owner}/${context.repo.repo}`
            )
            .replaceAll(
              '{REPO_OWNER_NAME_DASH}',
              `${context.repo.owner}-${context.repo.repo}`
            )
            .replaceAll(
              '{REPO_NAME}',
              context.repo.repo
            );
          
          // Append TTL parameter to each secret path if TTL is specified
          const ttl = process.env.TTL_INPUT;
          if (ttl && ttl.length > 0) {
            // Split by semicolon, append ttl= to each path, rejoin
            pattern = pattern.split(';').map(line => {
              line = line.trim();
              if (line.length === 0) return line;
              // Check if this line already has parameters
              const hasParams = line.includes('?') || line.includes(' ttl=');
              if (hasParams) {
                // Already has params, append with space
                return `${line} ttl=${ttl}`;
              } else {
                // No params yet, add with space after path
                const parts = line.split('|');
                if (parts.length >= 2) {
                  // Format: path key | VAR_NAME
                  // Insert ttl before the pipe
                  return `${parts[0].trim()} ttl=${ttl} | ${parts.slice(1).join('|').trim()}`;
                }
                return line;
              }
            }).join(';');
          }
          
          core.setOutput('pattern', pattern);
          core.setOutput('vault-role', `github-${context.repo.owner}-${context.repo.repo}`)
    - name: Vault Secrets
      id: secrets
      uses: hashicorp/vault-action@4c06c5ccf5c0761b6029f56cfb1dcf5565918a3b # v3.4.0
      with:
        url: ${{ inputs.url }}
        exportEnv: false
        method: jwt
        path: jwt-ghwf
        role: ${{ steps.replace.outputs.vault-role }}
        secrets: ${{ steps.replace.outputs.pattern }}
